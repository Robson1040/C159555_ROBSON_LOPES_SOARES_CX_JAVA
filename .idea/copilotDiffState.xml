<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/test/java/br/gov/caixa/api/investimentos/filter/AcessoLogFilterTest.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/test/java/br/gov/caixa/api/investimentos/filter/AcessoLogFilterTest.java" />
              <option name="originalContent" value="package br.gov.caixa.api.investimentos.filter;&#10;&#10;import br.gov.caixa.api.investimentos.service.telemetria.AcessoLogService;&#10;import br.gov.caixa.api.investimentos.service.telemetria.MetricasManager;&#10;import jakarta.enterprise.inject.Instance;&#10;import jakarta.ws.rs.container.ContainerRequestContext;&#10;import jakarta.ws.rs.container.ContainerResponseContext;&#10;import jakarta.ws.rs.core.UriInfo;&#10;import org.eclipse.microprofile.jwt.JsonWebToken;&#10;import org.junit.jupiter.api.BeforeEach;&#10;import org.junit.jupiter.api.Test;&#10;import org.mockito.ArgumentCaptor;&#10;&#10;import java.io.ByteArrayInputStream;&#10;import java.io.IOException;&#10;import java.io.InputStream;&#10;import java.lang.reflect.Method;&#10;import java.net.URI;&#10;&#10;import static org.junit.jupiter.api.Assertions.*;&#10;import static org.mockito.Mockito.*;&#10;&#10;class AcessoLogFilterTest {&#10;&#10;    private AcessoLogFilter filter;&#10;    private AcessoLogService acessoLogService;&#10;    private MetricasManager metricasManager;&#10;    private Instance&lt;JsonWebToken&gt; jwtInstance;&#10;    private JsonWebToken jwt;&#10;&#10;    private ContainerRequestContext requestContext;&#10;    private ContainerResponseContext responseContext;&#10;    private UriInfo uriInfo;&#10;&#10;    @BeforeEach&#10;    void setUp() {&#10;        filter = new AcessoLogFilter();&#10;        acessoLogService = mock(AcessoLogService.class);&#10;        metricasManager = mock(MetricasManager.class);&#10;        jwtInstance = mock(Instance.class);&#10;        jwt = mock(JsonWebToken.class);&#10;&#10;        // injetar dependências (são package-private no filter)&#10;        filter.acessoLogService = acessoLogService;&#10;        filter.metricasManager = metricasManager;&#10;        filter.jwtInstance = jwtInstance;&#10;&#10;        requestContext = mock(ContainerRequestContext.class);&#10;        responseContext = mock(ContainerResponseContext.class);&#10;        uriInfo = mock(UriInfo.class);&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_deveArmazenarTempoInicioECorpoNulo() throws Exception {&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;&#10;        filter.filter(requestContext);&#10;&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;        verify(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), isNull());&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_jwtNaoResolvel_deveIgnorarUsuario() throws Exception {&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(jwtInstance.isResolvable()).thenReturn(false);&#10;&#10;        filter.filter(requestContext);&#10;&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;        verify(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), isNull());&#10;        // não deve lançar exceção mesmo com jwt não resolvível&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_jwtClaimNaoNumerico_deveTratarNumberFormat() throws Exception {&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(jwtInstance.isResolvable()).thenReturn(true);&#10;        when(jwtInstance.get()).thenReturn(jwt);&#10;        when(jwt.getClaim(&quot;userId&quot;)).thenReturn(&quot;not-a-number&quot;);&#10;&#10;        filter.filter(requestContext);&#10;&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;        verify(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), isNull());&#10;        // Não lança exceção; claim inválido é tratado&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_excecaoDuranteProcessamento_naoPropaga() throws Exception {&#10;        // Fazer com que setProperty para o corpo lance exceção e verificar que método trata&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        doThrow(new RuntimeException(&quot;boom&quot;)).when(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), any());&#10;&#10;        // Mesmo lançando internamente, o método deve capturar a exceção e não propagá-la&#10;        filter.filter(requestContext);&#10;&#10;        // Start time ainda deve ter sido tentado&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_deveRegistrarAcesso_eRegistrarMetricas() throws Exception {&#10;        // preparar request context&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(System.currentTimeMillis() - 120);&#10;        when(requestContext.getProperty(&quot;acesso.log.corpo.requisicao&quot;)).thenReturn(&quot;corpo-req&quot;);&#10;&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(uriInfo.getRequestUri()).thenReturn(new URI(&quot;http://localhost/produtos/listar&quot;));&#10;        when(uriInfo.getPath()).thenReturn(&quot;/produtos/listar&quot;);&#10;&#10;        when(requestContext.getMethod()).thenReturn(&quot;GET&quot;);&#10;        when(requestContext.getHeaderString(&quot;User-Agent&quot;)).thenReturn(&quot;JUnit-Agent&quot;);&#10;        when(requestContext.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(&quot;10.0.0.1, 10.0.0.2&quot;);&#10;&#10;        // preparar jwt resolvable&#10;        when(jwtInstance.isResolvable()).thenReturn(true);&#10;        when(jwtInstance.get()).thenReturn(jwt);&#10;        when(jwt.getClaim(&quot;userId&quot;)).thenReturn(&quot;42&quot;);&#10;&#10;        when(responseContext.getStatus()).thenReturn(200);&#10;&#10;        filter.filter(requestContext, responseContext);&#10;&#10;        // capturar argumento passado para registrarAcesso&#10;        ArgumentCaptor&lt;Long&gt; usuarioCaptor = ArgumentCaptor.forClass(Long.class);&#10;        ArgumentCaptor&lt;String&gt; endpointCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; metodoCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; uriCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; ipCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; corpoReqCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;Integer&gt; statusCaptor = ArgumentCaptor.forClass(Integer.class);&#10;        ArgumentCaptor&lt;String&gt; corpoRespCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;Long&gt; tempoCaptor = ArgumentCaptor.forClass(Long.class);&#10;        ArgumentCaptor&lt;String&gt; uaCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; erroMsgCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; erroStackCaptor = ArgumentCaptor.forClass(String.class);&#10;&#10;        verify(acessoLogService, times(1)).registrarAcesso(&#10;                usuarioCaptor.capture(), endpointCaptor.capture(), metodoCaptor.capture(), uriCaptor.capture(),&#10;                ipCaptor.capture(), corpoReqCaptor.capture(), statusCaptor.capture(), corpoRespCaptor.capture(),&#10;                tempoCaptor.capture(), uaCaptor.capture(), erroMsgCaptor.capture(), erroStackCaptor.capture()&#10;        );&#10;&#10;        assertEquals(42L, usuarioCaptor.getValue());&#10;        assertEquals(&quot;produtos&quot;, endpointCaptor.getValue());&#10;        assertEquals(&quot;GET&quot;, metodoCaptor.getValue());&#10;        assertEquals(&quot;http://localhost/produtos/listar&quot;, uriCaptor.getValue());&#10;        assertEquals(&quot;10.0.0.1&quot;, ipCaptor.getValue());&#10;        assertEquals(&quot;corpo-req&quot;, corpoReqCaptor.getValue());&#10;        assertEquals(200, statusCaptor.getValue().intValue());&#10;        assertNull(corpoRespCaptor.getValue());&#10;        assertNotNull(tempoCaptor.getValue());&#10;        assertEquals(&quot;JUnit-Agent&quot;, uaCaptor.getValue());&#10;        assertNull(erroMsgCaptor.getValue());&#10;        assertNull(erroStackCaptor.getValue());&#10;&#10;        verify(metricasManager, times(1)).incrementarContador(&quot;produtos&quot;);&#10;        verify(metricasManager, times(1)).registrarTempoResposta(eq(&quot;produtos&quot;), anyLong());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_startTimeNull_naoFazNada() throws Exception {&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(null);&#10;        filter.filter(requestContext, responseContext);&#10;        verify(acessoLogService, never()).registrarAcesso(any(), anyString(), anyString(), anyString(), anyString(), anyString(), anyInt(), anyString(), anyLong(), anyString(), anyString(), anyString());&#10;        verify(metricasManager, never()).incrementarContador(anyString());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_jwtClaimNull_deveRegistrarComUsuarioNull() throws Exception {&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(System.currentTimeMillis() - 50);&#10;        when(requestContext.getProperty(&quot;acesso.log.corpo.requisicao&quot;)).thenReturn(null);&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(uriInfo.getRequestUri()).thenReturn(new URI(&quot;http://localhost/outro&quot;));&#10;        when(uriInfo.getPath()).thenReturn(&quot;/outro/path&quot;);&#10;        when(requestContext.getMethod()).thenReturn(&quot;GET&quot;);&#10;        when(requestContext.getHeaderString(&quot;User-Agent&quot;)).thenReturn(null);&#10;        when(requestContext.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(jwtInstance.isResolvable()).thenReturn(true);&#10;        when(jwtInstance.get()).thenReturn(jwt);&#10;        when(jwt.getClaim(&quot;userId&quot;)).thenReturn(null);&#10;        when(responseContext.getStatus()).thenReturn(200);&#10;&#10;        filter.filter(requestContext, responseContext);&#10;&#10;        verify(acessoLogService, times(1)).registrarAcesso(isNull(), anyString(), anyString(), anyString(), anyString(), any(), anyInt(), anyString(), anyLong(), anyString(), anyString(), anyString());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_status400_extraiMensagem_comVirgula() throws Exception {&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(System.currentTimeMillis() - 30);&#10;        when(requestContext.getProperty(&quot;acesso.log.corpo.requisicao&quot;)).thenReturn(null);&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(uriInfo.getRequestUri()).thenReturn(new URI(&quot;http://localhost/err&quot;));&#10;        when(uriInfo.getPath()).thenReturn(&quot;/err/path&quot;);&#10;        when(requestContext.getMethod()).thenReturn(&quot;GET&quot;);&#10;        when(requestContext.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(requestContext.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(jwtInstance.isResolvable()).thenReturn(false);&#10;        when(responseContext.getStatus()).thenReturn(400);&#10;        // corpo com message seguido de vírgula&#10;        String corpo = &quot;{\&quot;message\&quot;:\&quot;erro ocorrido\&quot;, \&quot;code\&quot;:123}&quot;;&#10;        // extrairCorpoResposta retorna null por LGPD; forçar retorno via spy no responseContext.getEntity()&#10;        when(responseContext.getEntity()).thenReturn(corpo);&#10;&#10;        filter.filter(requestContext, responseContext);&#10;&#10;        // verificar que registrou e que erro foi extraído&#10;        ArgumentCaptor&lt;String&gt; erroMsgCaptor = ArgumentCaptor.forClass(String.class);&#10;        verify(acessoLogService, times(1)).registrarAcesso(any(), anyString(), anyString(), anyString(), anyString(), any(), anyInt(), anyString(), anyLong(), anyString(), erroMsgCaptor.capture(), anyString());&#10;        assertEquals(&quot;erro ocorrido&quot;, erroMsgCaptor.getValue());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_status400_extraiMensagem_semVirgula() throws Exception {&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(System.currentTimeMillis() - 30);&#10;        when(requestContext.getProperty(&quot;acesso.log.corpo.requisicao&quot;)).thenReturn(null);&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(uriInfo.getRequestUri()).thenReturn(new URI(&quot;http://localhost/err2&quot;));&#10;        when(uriInfo.getPath()).thenReturn(&quot;/err2&quot;);&#10;        when(requestContext.getMethod()).thenReturn(&quot;GET&quot;);&#10;        when(requestContext.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(requestContext.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(jwtInstance.isResolvable()).thenReturn(false);&#10;        when(responseContext.getStatus()).thenReturn(500);&#10;        String corpo = &quot;{\&quot;message\&quot;:\&quot;erro final\&quot;}&quot;;&#10;        when(responseContext.getEntity()).thenReturn(corpo);&#10;&#10;        filter.filter(requestContext, responseContext);&#10;&#10;        ArgumentCaptor&lt;String&gt; erroMsgCaptor = ArgumentCaptor.forClass(String.class);&#10;        verify(acessoLogService, times(1)).registrarAcesso(any(), anyString(), anyString(), anyString(), anyString(), any(), anyInt(), anyString(), anyLong(), anyString(), erroMsgCaptor.capture(), anyString());&#10;        assertEquals(&quot;erro final&quot;, erroMsgCaptor.getValue());&#10;    }&#10;&#10;    @Test&#10;    void obterIpOrigem_desconhecido_quandoSemCabecalhos() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;obterIpOrigem&quot;, ContainerRequestContext.class);&#10;        m.setAccessible(true);&#10;&#10;        ContainerRequestContext rc = mock(ContainerRequestContext.class);&#10;        when(rc.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;Host&quot;)).thenReturn(null);&#10;&#10;        assertEquals(&quot;desconhecido&quot;, m.invoke(filter, rc));&#10;    }&#10;&#10;    @Test&#10;    void readInputStream_retornaBytes() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;readInputStream&quot;, InputStream.class);&#10;        m.setAccessible(true);&#10;&#10;        byte[] data = &quot;hello world&quot;.getBytes();&#10;        ByteArrayInputStream in = new ByteArrayInputStream(data);&#10;        byte[] result = (byte[]) m.invoke(filter, in);&#10;        assertArrayEquals(data, result);&#10;    }&#10;&#10;    @Test&#10;    void extrairEndpoint_variosCaminhos_retornaCorreto() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairEndpoint&quot;, String.class);&#10;        m.setAccessible(true);&#10;&#10;        assertEquals(&quot;simular-investimento&quot;, m.invoke(filter, &quot;/simular-investimento/123&quot;));&#10;        assertEquals(&quot;perfil-risco&quot;, m.invoke(filter, &quot;/perfil-risco/detalhe&quot;));&#10;        assertEquals(&quot;produtos-recomendados&quot;, m.invoke(filter, &quot;/produtos-recomendados/abc&quot;));&#10;        assertEquals(&quot;produtos&quot;, m.invoke(filter, &quot;/produtos/listar&quot;));&#10;        assertEquals(&quot;investimentos&quot;, m.invoke(filter, &quot;/investimentos/1&quot;));&#10;        assertEquals(&quot;clientes&quot;, m.invoke(filter, &quot;/clientes/1&quot;));&#10;        assertEquals(&quot;telemetria&quot;, m.invoke(filter, &quot;/telemetria/status&quot;));&#10;        assertEquals(&quot;simulacoes&quot;, m.invoke(filter, &quot;/simulacoes/xx&quot;));&#10;        assertEquals(&quot;autenticacao&quot;, m.invoke(filter, &quot;/entrar&quot;));&#10;        assertEquals(&quot;root&quot;, m.invoke(filter, &quot;&quot;));&#10;        assertEquals(&quot;root&quot;, m.invoke(filter, (Object) null));&#10;    }&#10;&#10;    @Test&#10;    void obterIpOrigem_prioridadeDeCabecalhos() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;obterIpOrigem&quot;, ContainerRequestContext.class);&#10;        m.setAccessible(true);&#10;&#10;        ContainerRequestContext rc = mock(ContainerRequestContext.class);&#10;        when(rc.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(&quot;1.1.1.1,2.2.2.2&quot;);&#10;        assertEquals(&quot;1.1.1.1&quot;, m.invoke(filter, rc));&#10;&#10;        when(rc.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(&quot;3.3.3.3&quot;);&#10;        assertEquals(&quot;3.3.3.3&quot;, m.invoke(filter, rc));&#10;&#10;        when(rc.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;Host&quot;)).thenReturn(&quot;example.com:8080&quot;);&#10;        assertEquals(&quot;example.com&quot;, m.invoke(filter, rc));&#10;    }&#10;&#10;    @Test&#10;    void temCorpoRequisicao_deveIdentificarMetodos() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;temCorpoRequisicao&quot;, ContainerRequestContext.class);&#10;        m.setAccessible(true);&#10;&#10;        ContainerRequestContext rc = mock(ContainerRequestContext.class);&#10;        when(rc.getMethod()).thenReturn(&quot;POST&quot;);&#10;        assertTrue((Boolean) m.invoke(filter, rc));&#10;&#10;        when(rc.getMethod()).thenReturn(&quot;PUT&quot;);&#10;        assertTrue((Boolean) m.invoke(filter, rc));&#10;&#10;        when(rc.getMethod()).thenReturn(&quot;PATCH&quot;);&#10;        assertTrue((Boolean) m.invoke(filter, rc));&#10;&#10;        when(rc.getMethod()).thenReturn(&quot;GET&quot;);&#10;        assertFalse((Boolean) m.invoke(filter, rc));&#10;    }&#10;&#10;    @Test&#10;    void extrairMensagemErro_parseSimples() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairMensagemErro&quot;, String.class);&#10;        m.setAccessible(true);&#10;&#10;        String json = &quot;{\&quot;message\&quot;:\&quot;erro ocorrido\&quot;, \&quot;code\&quot;:123}&quot;;&#10;        assertEquals(&quot;erro ocorrido&quot;, m.invoke(filter, json));&#10;&#10;        assertNull(m.invoke(filter, &quot;{}&quot;));&#10;        assertNull(m.invoke(filter, (Object) null));&#10;    }&#10;&#10;    @Test&#10;    void extrairCorpoRequisicaoEResposta_retornamNulos_porLGPD() throws Exception {&#10;        Method mReq = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairCorpoRequisicao&quot;, ContainerRequestContext.class);&#10;        mReq.setAccessible(true);&#10;        when(requestContext.getEntityStream()).thenReturn(null);&#10;        assertNull(mReq.invoke(filter, requestContext));&#10;&#10;        Method mResp = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairCorpoResposta&quot;, ContainerResponseContext.class);&#10;        mResp.setAccessible(true);&#10;        assertNull(mResp.invoke(filter, responseContext));&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package br.gov.caixa.api.investimentos.filter;&#10;&#10;import br.gov.caixa.api.investimentos.service.telemetria.AcessoLogService;&#10;import br.gov.caixa.api.investimentos.service.telemetria.MetricasManager;&#10;import jakarta.enterprise.inject.Instance;&#10;import jakarta.ws.rs.container.ContainerRequestContext;&#10;import jakarta.ws.rs.container.ContainerResponseContext;&#10;import jakarta.ws.rs.core.UriInfo;&#10;import org.eclipse.microprofile.jwt.JsonWebToken;&#10;import org.junit.jupiter.api.BeforeEach;&#10;import org.junit.jupiter.api.Test;&#10;import org.mockito.ArgumentCaptor;&#10;&#10;import java.io.ByteArrayInputStream;&#10;import java.io.InputStream;&#10;import java.lang.reflect.Method;&#10;import java.net.URI;&#10;&#10;import static org.junit.jupiter.api.Assertions.*;&#10;import static org.mockito.Mockito.*;&#10;&#10;class AcessoLogFilterTest {&#10;&#10;    private AcessoLogFilter filter;&#10;    private AcessoLogService acessoLogService;&#10;    private MetricasManager metricasManager;&#10;    private Instance&lt;JsonWebToken&gt; jwtInstance;&#10;    private JsonWebToken jwt;&#10;&#10;    private ContainerRequestContext requestContext;&#10;    private ContainerResponseContext responseContext;&#10;    private UriInfo uriInfo;&#10;&#10;    @BeforeEach&#10;    void setUp() {&#10;        filter = new AcessoLogFilter();&#10;        acessoLogService = mock(AcessoLogService.class);&#10;        metricasManager = mock(MetricasManager.class);&#10;        @SuppressWarnings(&quot;unchecked&quot;)&#10;        Instance&lt;JsonWebToken&gt; tempJwt = mock(Instance.class);&#10;        jwtInstance = tempJwt;&#10;        jwt = mock(JsonWebToken.class);&#10;&#10;        // injetar dependências (são package-private no filter)&#10;        filter.acessoLogService = acessoLogService;&#10;        filter.metricasManager = metricasManager;&#10;        filter.jwtInstance = jwtInstance;&#10;&#10;        requestContext = mock(ContainerRequestContext.class);&#10;        responseContext = mock(ContainerResponseContext.class);&#10;        uriInfo = mock(UriInfo.class);&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_deveArmazenarTempoInicioECorpoNulo() throws Exception {&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;&#10;        filter.filter(requestContext);&#10;&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;        verify(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), isNull());&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_jwtNaoResolvel_deveIgnorarUsuario() throws Exception {&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(jwtInstance.isResolvable()).thenReturn(false);&#10;&#10;        filter.filter(requestContext);&#10;&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;        verify(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), isNull());&#10;        // não deve lançar exceção mesmo com jwt não resolvível&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_jwtClaimNaoNumerico_deveTratarNumberFormat() throws Exception {&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(jwtInstance.isResolvable()).thenReturn(true);&#10;        when(jwtInstance.get()).thenReturn(jwt);&#10;        when(jwt.getClaim(&quot;userId&quot;)).thenReturn(&quot;not-a-number&quot;);&#10;&#10;        filter.filter(requestContext);&#10;&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;        verify(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), isNull());&#10;        // Não lança exceção; claim inválido é tratado&#10;    }&#10;&#10;    @Test&#10;    void filterRequest_excecaoDuranteProcessamento_naoPropaga() throws Exception {&#10;        // Fazer com que setProperty para o corpo lance exceção e verificar que método trata&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        doThrow(new RuntimeException(&quot;boom&quot;)).when(requestContext).setProperty(eq(&quot;acesso.log.corpo.requisicao&quot;), any());&#10;&#10;        // Mesmo lançando internamente, o método deve capturar a exceção e não propagá-la&#10;        filter.filter(requestContext);&#10;&#10;        // Start time ainda deve ter sido tentado&#10;        verify(requestContext).setProperty(eq(&quot;telemetria.start.time&quot;), anyLong());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_deveRegistrarAcesso_eRegistrarMetricas() throws Exception {&#10;        // preparar request context&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(System.currentTimeMillis() - 120);&#10;        when(requestContext.getProperty(&quot;acesso.log.corpo.requisicao&quot;)).thenReturn(&quot;corpo-req&quot;);&#10;&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(uriInfo.getRequestUri()).thenReturn(new URI(&quot;http://localhost/produtos/listar&quot;));&#10;        when(uriInfo.getPath()).thenReturn(&quot;/produtos/listar&quot;);&#10;&#10;        when(requestContext.getMethod()).thenReturn(&quot;GET&quot;);&#10;        when(requestContext.getHeaderString(&quot;User-Agent&quot;)).thenReturn(&quot;JUnit-Agent&quot;);&#10;        when(requestContext.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(&quot;10.0.0.1, 10.0.0.2&quot;);&#10;&#10;        // preparar jwt resolvable&#10;        when(jwtInstance.isResolvable()).thenReturn(true);&#10;        when(jwtInstance.get()).thenReturn(jwt);&#10;        when(jwt.getClaim(&quot;userId&quot;)).thenReturn(&quot;42&quot;);&#10;&#10;        when(responseContext.getStatus()).thenReturn(200);&#10;&#10;        filter.filter(requestContext, responseContext);&#10;&#10;        // capturar argumento passado para registrarAcesso&#10;        ArgumentCaptor&lt;Long&gt; usuarioCaptor = ArgumentCaptor.forClass(Long.class);&#10;        ArgumentCaptor&lt;String&gt; endpointCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; metodoCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; uriCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; ipCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; corpoReqCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;Integer&gt; statusCaptor = ArgumentCaptor.forClass(Integer.class);&#10;        ArgumentCaptor&lt;String&gt; corpoRespCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;Long&gt; tempoCaptor = ArgumentCaptor.forClass(Long.class);&#10;        ArgumentCaptor&lt;String&gt; uaCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; erroMsgCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; erroStackCaptor = ArgumentCaptor.forClass(String.class);&#10;&#10;        verify(acessoLogService, times(1)).registrarAcesso(&#10;                usuarioCaptor.capture(), endpointCaptor.capture(), metodoCaptor.capture(), uriCaptor.capture(),&#10;                ipCaptor.capture(), corpoReqCaptor.capture(), statusCaptor.capture(), corpoRespCaptor.capture(),&#10;                tempoCaptor.capture(), uaCaptor.capture(), erroMsgCaptor.capture(), erroStackCaptor.capture()&#10;        );&#10;&#10;        assertEquals(42L, usuarioCaptor.getValue());&#10;        assertEquals(&quot;produtos&quot;, endpointCaptor.getValue());&#10;        assertEquals(&quot;GET&quot;, metodoCaptor.getValue());&#10;        assertEquals(&quot;http://localhost/produtos/listar&quot;, uriCaptor.getValue());&#10;        assertEquals(&quot;10.0.0.1&quot;, ipCaptor.getValue());&#10;        assertEquals(&quot;corpo-req&quot;, corpoReqCaptor.getValue());&#10;        assertEquals(200, statusCaptor.getValue().intValue());&#10;        assertNull(corpoRespCaptor.getValue());&#10;        assertNotNull(tempoCaptor.getValue());&#10;        assertEquals(&quot;JUnit-Agent&quot;, uaCaptor.getValue());&#10;        assertNull(erroMsgCaptor.getValue());&#10;        assertNull(erroStackCaptor.getValue());&#10;&#10;        verify(metricasManager, times(1)).incrementarContador(&quot;produtos&quot;);&#10;        verify(metricasManager, times(1)).registrarTempoResposta(eq(&quot;produtos&quot;), anyLong());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_startTimeNull_naoFazNada() throws Exception {&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(null);&#10;        filter.filter(requestContext, responseContext);&#10;        verify(acessoLogService, never()).registrarAcesso(any(), anyString(), anyString(), anyString(), anyString(), anyString(), anyInt(), anyString(), anyLong(), anyString(), anyString(), anyString());&#10;        verify(metricasManager, never()).incrementarContador(anyString());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_jwtClaimNull_deveRegistrarComUsuarioNull() throws Exception {&#10;        when(requestContext.getProperty(&quot;telemetria.start.time&quot;)).thenReturn(System.currentTimeMillis() - 50);&#10;        when(requestContext.getProperty(&quot;acesso.log.corpo.requisicao&quot;)).thenReturn(null);&#10;        when(requestContext.getUriInfo()).thenReturn(uriInfo);&#10;        when(uriInfo.getRequestUri()).thenReturn(new URI(&quot;http://localhost/outro&quot;));&#10;        when(uriInfo.getPath()).thenReturn(&quot;/outro/path&quot;);&#10;        when(requestContext.getMethod()).thenReturn(&quot;GET&quot;);&#10;        when(requestContext.getHeaderString(&quot;User-Agent&quot;)).thenReturn(null);&#10;        when(requestContext.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(requestContext.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(requestContext.getHeaderString(&quot;Host&quot;)).thenReturn(&quot;localhost&quot;);&#10;        when(jwtInstance.isResolvable()).thenReturn(true);&#10;        when(jwtInstance.get()).thenReturn(jwt);&#10;        when(jwt.getClaim(&quot;userId&quot;)).thenReturn(null);&#10;        when(responseContext.getStatus()).thenReturn(200);&#10;&#10;        filter.filter(requestContext, responseContext);&#10;&#10;        // Verifica que registrou com usuarioId = null&#10;        ArgumentCaptor&lt;Long&gt; usuarioCaptor = ArgumentCaptor.forClass(Long.class);&#10;        ArgumentCaptor&lt;String&gt; endpointCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; metodoCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; uriCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;String&gt; ipCaptor = ArgumentCaptor.forClass(String.class);&#10;        ArgumentCaptor&lt;Integer&gt; statusCaptor = ArgumentCaptor.forClass(Integer.class);&#10;        &#10;        verify(acessoLogService, times(1)).registrarAcesso(&#10;                usuarioCaptor.capture(), endpointCaptor.capture(), metodoCaptor.capture(), uriCaptor.capture(),&#10;                ipCaptor.capture(), any(), statusCaptor.capture(), any(), anyLong(), any(), any(), any()&#10;        );&#10;        &#10;        assertNull(usuarioCaptor.getValue());&#10;        assertEquals(&quot;outro&quot;, endpointCaptor.getValue());&#10;        assertEquals(&quot;GET&quot;, metodoCaptor.getValue());&#10;        assertEquals(&quot;http://localhost/outro&quot;, uriCaptor.getValue());&#10;        assertEquals(&quot;desconhecido&quot;, ipCaptor.getValue());&#10;        assertEquals(200, statusCaptor.getValue().intValue());&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_status400_extraiMensagem_comVirgula() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairMensagemErro&quot;, String.class);&#10;        m.setAccessible(true);&#10;&#10;        String corpo = &quot;{\&quot;message\&quot;:\&quot;erro ocorrido\&quot;, \&quot;code\&quot;:123}&quot;;&#10;        String resultado = (String) m.invoke(filter, corpo);&#10;&#10;        assertEquals(&quot;erro ocorrido&quot;, resultado);&#10;    }&#10;&#10;    @Test&#10;    void filterResponse_status400_extraiMensagem_semVirgula() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairMensagemErro&quot;, String.class);&#10;        m.setAccessible(true);&#10;&#10;        String corpo = &quot;{\&quot;message\&quot;:\&quot;erro final\&quot;}&quot;;&#10;        String resultado = (String) m.invoke(filter, corpo);&#10;&#10;        assertEquals(&quot;erro final&quot;, resultado);&#10;    }&#10;&#10;    @Test&#10;    void obterIpOrigem_desconhecido_quandoSemCabecalhos() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;obterIpOrigem&quot;, ContainerRequestContext.class);&#10;        m.setAccessible(true);&#10;&#10;        ContainerRequestContext rc = mock(ContainerRequestContext.class);&#10;        when(rc.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;Host&quot;)).thenReturn(null);&#10;&#10;        assertEquals(&quot;desconhecido&quot;, m.invoke(filter, rc));&#10;    }&#10;&#10;    @Test&#10;    void readInputStream_retornaBytes() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;readInputStream&quot;, InputStream.class);&#10;        m.setAccessible(true);&#10;&#10;        byte[] data = &quot;hello world&quot;.getBytes();&#10;        ByteArrayInputStream in = new ByteArrayInputStream(data);&#10;        byte[] result = (byte[]) m.invoke(filter, in);&#10;        assertArrayEquals(data, result);&#10;    }&#10;&#10;    @Test&#10;    void extrairEndpoint_variosCaminhos_retornaCorreto() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairEndpoint&quot;, String.class);&#10;        m.setAccessible(true);&#10;&#10;        assertEquals(&quot;simular-investimento&quot;, m.invoke(filter, &quot;/simular-investimento/123&quot;));&#10;        assertEquals(&quot;perfil-risco&quot;, m.invoke(filter, &quot;/perfil-risco/detalhe&quot;));&#10;        assertEquals(&quot;produtos-recomendados&quot;, m.invoke(filter, &quot;/produtos-recomendados/abc&quot;));&#10;        assertEquals(&quot;produtos&quot;, m.invoke(filter, &quot;/produtos/listar&quot;));&#10;        assertEquals(&quot;investimentos&quot;, m.invoke(filter, &quot;/investimentos/1&quot;));&#10;        assertEquals(&quot;clientes&quot;, m.invoke(filter, &quot;/clientes/1&quot;));&#10;        assertEquals(&quot;telemetria&quot;, m.invoke(filter, &quot;/telemetria/status&quot;));&#10;        assertEquals(&quot;simulacoes&quot;, m.invoke(filter, &quot;/simulacoes/xx&quot;));&#10;        assertEquals(&quot;autenticacao&quot;, m.invoke(filter, &quot;/entrar&quot;));&#10;        assertEquals(&quot;root&quot;, m.invoke(filter, &quot;&quot;));&#10;        assertEquals(&quot;root&quot;, m.invoke(filter, (Object) null));&#10;    }&#10;&#10;    @Test&#10;    void obterIpOrigem_prioridadeDeCabecalhos() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;obterIpOrigem&quot;, ContainerRequestContext.class);&#10;        m.setAccessible(true);&#10;&#10;        ContainerRequestContext rc = mock(ContainerRequestContext.class);&#10;        when(rc.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(&quot;1.1.1.1,2.2.2.2&quot;);&#10;        assertEquals(&quot;1.1.1.1&quot;, m.invoke(filter, rc));&#10;&#10;        when(rc.getHeaderString(&quot;X-Forwarded-For&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(&quot;3.3.3.3&quot;);&#10;        assertEquals(&quot;3.3.3.3&quot;, m.invoke(filter, rc));&#10;&#10;        when(rc.getHeaderString(&quot;X-Real-IP&quot;)).thenReturn(null);&#10;        when(rc.getHeaderString(&quot;Host&quot;)).thenReturn(&quot;example.com:8080&quot;);&#10;        assertEquals(&quot;example.com&quot;, m.invoke(filter, rc));&#10;    }&#10;&#10;    @Test&#10;    void temCorpoRequisicao_deveIdentificarMetodos() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;temCorpoRequisicao&quot;, ContainerRequestContext.class);&#10;        m.setAccessible(true);&#10;&#10;        ContainerRequestContext rc = mock(ContainerRequestContext.class);&#10;        when(rc.getMethod()).thenReturn(&quot;POST&quot;);&#10;        assertTrue((Boolean) m.invoke(filter, rc));&#10;&#10;        when(rc.getMethod()).thenReturn(&quot;PUT&quot;);&#10;        assertTrue((Boolean) m.invoke(filter, rc));&#10;&#10;        when(rc.getMethod()).thenReturn(&quot;PATCH&quot;);&#10;        assertTrue((Boolean) m.invoke(filter, rc));&#10;&#10;        when(rc.getMethod()).thenReturn(&quot;GET&quot;);&#10;        assertFalse((Boolean) m.invoke(filter, rc));&#10;    }&#10;&#10;    @Test&#10;    void extrairMensagemErro_parseSimples() throws Exception {&#10;        Method m = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairMensagemErro&quot;, String.class);&#10;        m.setAccessible(true);&#10;&#10;        String json = &quot;{\&quot;message\&quot;:\&quot;erro ocorrido\&quot;, \&quot;code\&quot;:123}&quot;;&#10;        assertEquals(&quot;erro ocorrido&quot;, m.invoke(filter, json));&#10;&#10;        assertNull(m.invoke(filter, &quot;{}&quot;));&#10;        assertNull(m.invoke(filter, (Object) null));&#10;    }&#10;&#10;    @Test&#10;    void extrairCorpoRequisicaoEResposta_retornamNulos_porLGPD() throws Exception {&#10;        Method mReq = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairCorpoRequisicao&quot;, ContainerRequestContext.class);&#10;        mReq.setAccessible(true);&#10;        when(requestContext.getEntityStream()).thenReturn(null);&#10;        assertNull(mReq.invoke(filter, requestContext));&#10;&#10;        Method mResp = AcessoLogFilter.class.getDeclaredMethod(&quot;extrairCorpoResposta&quot;, ContainerResponseContext.class);&#10;        mResp.setAccessible(true);&#10;        assertNull(mResp.invoke(filter, responseContext));&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>