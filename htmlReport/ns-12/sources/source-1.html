


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > GeradorRecomendacaoML</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">br.gov.caixa.api.investimentos.ml</a>
</div>

<h1>Coverage Summary for Class: GeradorRecomendacaoML (br.gov.caixa.api.investimentos.ml)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">GeradorRecomendacaoML</td>
<td class="coverageStat">
  <span class="percent">
    81,8%
  </span>
  <span class="absValue">
    (9/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    52,7%
  </span>
  <span class="absValue">
    (49/93)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    81,4%
  </span>
  <span class="absValue">
    (96/118)
  </span>
</td>
</tr>
  <tr>
    <td class="name">GeradorRecomendacaoML$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    83,3%
  </span>
  <span class="absValue">
    (10/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    52,7%
  </span>
  <span class="absValue">
    (49/93)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    81,7%
  </span>
  <span class="absValue">
    (98/120)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package br.gov.caixa.api.investimentos.ml;
&nbsp;
&nbsp;import br.gov.caixa.api.investimentos.enums.produto.PeriodoRentabilidade;
&nbsp;import br.gov.caixa.api.investimentos.enums.produto.TipoProduto;
&nbsp;import br.gov.caixa.api.investimentos.enums.produto.TipoRentabilidade;
&nbsp;import br.gov.caixa.api.investimentos.enums.simulacao.Indice;
&nbsp;import br.gov.caixa.api.investimentos.model.investimento.Investimento;
&nbsp;import br.gov.caixa.api.investimentos.model.produto.Produto;
&nbsp;import br.gov.caixa.api.investimentos.model.simulacao.SimulacaoInvestimento;
&nbsp;import jakarta.enterprise.context.ApplicationScoped;
&nbsp;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;
&nbsp;@ApplicationScoped
<b class="fc">&nbsp;public class GeradorRecomendacaoML</b>
&nbsp;{
&nbsp;    /**
&nbsp;     * Encontra o produto com perfil ideal para o cliente, com base nos investimentos
&nbsp;     */
&nbsp;    public List&lt;Produto&gt; encontrarProdutosOrdenadosPorAparicao(List&lt;Investimento&gt; investimentos,
&nbsp;                                                               List&lt;Produto&gt; todosProdutos)
&nbsp;    {
<b class="fc">&nbsp;        Map&lt;Produto, Integer&gt; contador = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        for (Investimento investimento : investimentos) {</b>
<b class="fc">&nbsp;            Produto produtoMaisProximo = null;</b>
<b class="fc">&nbsp;            double menorDistancia = Double.MAX_VALUE;</b>
<b class="fc">&nbsp;            int peso = investimento.getValor().intValue();</b>
&nbsp;
<b class="fc">&nbsp;            for (Produto produto : todosProdutos) {</b>
&nbsp;                // IGNORA o &quot;mesmo produto&quot;
<b class="fc">&nbsp;                if (investimento.getProdutoId().equals(produto.getId())) {</b>
&nbsp;                    continue;
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                double distancia = calcularDistanciaEuclidiana(investimento, produto, todosProdutos);</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;                if (distancia &lt; menorDistancia) {</b>
<b class="fc">&nbsp;                    menorDistancia = distancia;</b>
<b class="fc">&nbsp;                    produtoMaisProximo = produto;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="pc">&nbsp;            if (produtoMaisProximo != null)</b>
&nbsp;            {
<b class="fc">&nbsp;                produtoMaisProximo.setPontuacao(produtoMaisProximo.getPontuacao() + peso);</b>
<b class="fc">&nbsp;                contador.merge(produtoMaisProximo, peso, Integer::sum);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Retorna os produtos ordenados pela contagem (decrescente)
<b class="fc">&nbsp;        return contador.entrySet()</b>
<b class="fc">&nbsp;                .stream()</b>
<b class="fc">&nbsp;                .sorted((a, b) -&gt; b.getValue().compareTo(a.getValue()))</b>
<b class="fc">&nbsp;                .map(Map.Entry::getKey)</b>
<b class="fc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Calcula distância euclidiana entre investimento e produto
&nbsp;     */
&nbsp;    public List&lt;Produto&gt; encontrarProdutosOrdenadosPorAparicaoSimulacao(
&nbsp;            List&lt;SimulacaoInvestimento&gt; investimentos,
&nbsp;            List&lt;Produto&gt; todosProdutos)
&nbsp;    {
<b class="fc">&nbsp;        Map&lt;Produto, Integer&gt; contador = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;        for (SimulacaoInvestimento simulacao : investimentos) {</b>
<b class="fc">&nbsp;            Produto produtoMaisProximo = null;</b>
<b class="fc">&nbsp;            double menorDistancia = Double.MAX_VALUE;</b>
<b class="fc">&nbsp;            int peso = simulacao.getValorInvestido().intValue();</b>
&nbsp;
<b class="fc">&nbsp;            for (Produto produto : todosProdutos) {</b>
&nbsp;                // IGNORA o &quot;mesmo produto&quot;
<b class="fc">&nbsp;                if (simulacao.getProdutoId().equals(produto.getId())) {</b>
&nbsp;                    continue;
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                double distancia = calcularDistanciaEuclidiana(simulacao, produto, todosProdutos);</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;                if (distancia &lt; menorDistancia) {</b>
<b class="fc">&nbsp;                    menorDistancia = distancia;</b>
<b class="fc">&nbsp;                    produtoMaisProximo = produto;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="pc">&nbsp;            if (produtoMaisProximo != null) {</b>
<b class="fc">&nbsp;                produtoMaisProximo.setPontuacao(produtoMaisProximo.getPontuacao() + peso);</b>
<b class="fc">&nbsp;                contador.merge(produtoMaisProximo, peso, Integer::sum);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Retorna os produtos ordenados pela contagem (decrescente)
<b class="fc">&nbsp;        return contador.entrySet()</b>
<b class="fc">&nbsp;                .stream()</b>
<b class="fc">&nbsp;                .sorted((a, b) -&gt; b.getValue().compareTo(a.getValue()))</b>
<b class="fc">&nbsp;                .map(Map.Entry::getKey)</b>
<b class="fc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Calcula distância euclidiana entre simulação e produto
&nbsp;     */
&nbsp;    private double calcularDistanciaEuclidiana(Object entrada, Produto produto, List&lt;Produto&gt; todoProdutos)
&nbsp;    {
&nbsp;        double valorNorm;
&nbsp;        double tipoNorm;
&nbsp;        double tipoRentNorm;
&nbsp;        double periodoRentNorm;
&nbsp;        double indiceNorm;
&nbsp;        double liquidezNorm;
&nbsp;        double fgcNorm;
&nbsp;        double minimoInvNorm;
&nbsp;
&nbsp;        // === CASO 1: Investimento real ===
<b class="fc">&nbsp;        if (entrada instanceof Investimento investimento)</b>
&nbsp;        {
<b class="fc">&nbsp;            valorNorm = normalizar(investimento.getValor().doubleValue(), 0, 1_000_000);</b>
<b class="fc">&nbsp;            tipoNorm = normalizarTipoProduto(investimento.getTipo());</b>
<b class="fc">&nbsp;            tipoRentNorm = normalizarTipoRentabilidade(investimento.getTipoRentabilidade());</b>
<b class="fc">&nbsp;            periodoRentNorm = normalizarPeriodoRentabilidade(investimento.getPeriodoRentabilidade());</b>
<b class="fc">&nbsp;            indiceNorm = normalizarIndice(investimento.getIndice());</b>
<b class="fc">&nbsp;            liquidezNorm = normalizar(</b>
<b class="pc">&nbsp;                    investimento.getLiquidez() != null ? investimento.getLiquidez() : 0,</b>
&nbsp;                    -1, 365
&nbsp;            );
<b class="pc">&nbsp;            fgcNorm = investimento.getFgc() != null &amp;&amp; investimento.getFgc() ? 1.0 : 0.0;</b>
<b class="fc">&nbsp;            minimoInvNorm = normalizar(</b>
<b class="pc">&nbsp;                    investimento.getMinimoDiasInvestimento() != null ? investimento.getMinimoDiasInvestimento() : 0,</b>
&nbsp;                    0, 1800
&nbsp;            );
&nbsp;        }
&nbsp;
&nbsp;        // === CASO 2: Simulação ===
<b class="pc">&nbsp;        else if (entrada instanceof SimulacaoInvestimento simulacao)</b>
&nbsp;        {
<b class="fc">&nbsp;            valorNorm = normalizar(simulacao.getValorInvestido().doubleValue(), 0, 1_000_000);</b>
&nbsp;
<b class="fc">&nbsp;            Produto p = null;</b>
&nbsp;
<b class="pc">&nbsp;            for (Produto todoProduto : todoProdutos) {</b>
<b class="fc">&nbsp;                if (Objects.equals(simulacao.getProdutoId(), todoProduto.getId()))</b>
&nbsp;                {
<b class="fc">&nbsp;                    p = todoProduto;</b>
&nbsp;                    break;
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="pc">&nbsp;            if(p == null)</b>
&nbsp;            {
<b class="nc">&nbsp;                throw new IllegalArgumentException(</b>
<b class="nc">&nbsp;                        &quot;Produto não encontrado para simulação com produtoId: &quot; + simulacao.getProdutoId()</b>
&nbsp;                );
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            tipoNorm = p.getTipo().getValor();</b>
<b class="fc">&nbsp;            tipoRentNorm = 0.5;</b>
<b class="fc">&nbsp;            periodoRentNorm = 0.5;</b>
<b class="fc">&nbsp;            indiceNorm = 0.5;</b>
<b class="fc">&nbsp;            liquidezNorm = 0.5;</b>
<b class="pc">&nbsp;            fgcNorm = p.getFgc() != null &amp;&amp; p.getFgc() ? 1.0 : 0.0;</b>
<b class="fc">&nbsp;            minimoInvNorm = 0.5;</b>
&nbsp;        }
&nbsp;
&nbsp;        else
&nbsp;        {
<b class="nc">&nbsp;            throw new IllegalArgumentException(</b>
<b class="nc">&nbsp;                    &quot;Tipo não suportado: &quot; + entrada.getClass()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
&nbsp;        // === Valores normais do produto ===
<b class="fc">&nbsp;        double prodValorNorm = 0.5;</b>
<b class="fc">&nbsp;        double prodTipoNorm = normalizarTipoProduto(produto.getTipo());</b>
<b class="fc">&nbsp;        double prodTipoRentNorm = normalizarTipoRentabilidade(produto.getTipoRentabilidade());</b>
<b class="fc">&nbsp;        double prodPeriodoRentNorm = normalizarPeriodoRentabilidade(produto.getPeriodoRentabilidade());</b>
<b class="fc">&nbsp;        double prodIndiceNorm = normalizarIndice(produto.getIndice());</b>
<b class="fc">&nbsp;        double prodLiquidezNorm = normalizar(produto.getLiquidez(), -1, 365);</b>
<b class="fc">&nbsp;        double prodFgcNorm = produto.getFgc() ? 1.0 : 0.0;</b>
<b class="fc">&nbsp;        double prodMinimoInvNorm = normalizar(produto.getMinimoDiasInvestimento(), 0, 1800);</b>
&nbsp;
&nbsp;        // === Distância final ===
<b class="fc">&nbsp;        return Math.sqrt(</b>
<b class="fc">&nbsp;                Math.pow(valorNorm - prodValorNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(tipoNorm - prodTipoNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(tipoRentNorm - prodTipoRentNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(periodoRentNorm - prodPeriodoRentNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(indiceNorm - prodIndiceNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(liquidezNorm - prodLiquidezNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(fgcNorm - prodFgcNorm, 2) +</b>
<b class="fc">&nbsp;                        Math.pow(minimoInvNorm - prodMinimoInvNorm, 2)</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Normaliza valores para escala 0-1
&nbsp;     */
&nbsp;    private double normalizar(double valor, double min, double max) {
<b class="pc">&nbsp;        if (max == min) return 0.5;</b>
<b class="fc">&nbsp;        return Math.max(0, Math.min(1, (valor - min) / (max - min)));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Normaliza tipo de produto para valor numérico
&nbsp;     */
&nbsp;    private double normalizarTipoProduto(TipoProduto tipo) {
<b class="fc">&nbsp;        return tipo.getValor();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Normaliza tipo de rentabilidade para valor numérico
&nbsp;     */
&nbsp;    private double normalizarTipoRentabilidade(TipoRentabilidade tipo) {
<b class="pc">&nbsp;        if (tipo == null) return 0.5;</b>
<b class="fc">&nbsp;        return tipo == TipoRentabilidade.PRE ? 0.0 : 1.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Normaliza período de rentabilidade para valor numérico
&nbsp;     */
&nbsp;    private double normalizarPeriodoRentabilidade(PeriodoRentabilidade periodo) {
<b class="pc">&nbsp;        if (periodo == null) return 0.5;</b>
<b class="pc">&nbsp;        return switch (periodo) {</b>
<b class="nc">&nbsp;            case AO_DIA -&gt; 0.0;</b>
<b class="fc">&nbsp;            case AO_MES -&gt; 0.33;</b>
<b class="fc">&nbsp;            case AO_ANO -&gt; 0.66;</b>
<b class="nc">&nbsp;            case PERIODO_TOTAL -&gt; 1.0;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Normaliza índice para valor numérico
&nbsp;     */
&nbsp;    private double normalizarIndice(Indice indice) {
<b class="fc">&nbsp;        if (indice == null || indice == Indice.NENHUM) return 0.0;</b>
<b class="pc">&nbsp;        return switch (indice) {</b>
<b class="fc">&nbsp;            case SELIC -&gt; 0.2;</b>
<b class="fc">&nbsp;            case CDI -&gt; 0.4;</b>
<b class="fc">&nbsp;            case IPCA -&gt; 0.6;</b>
<b class="nc">&nbsp;            case IGP_M -&gt; 0.8;</b>
<b class="fc">&nbsp;            case IBOVESPA -&gt; 1.0;</b>
<b class="nc">&nbsp;            default -&gt; 0.0;</b>
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Infere tipo de produto baseado no nome da simulação
&nbsp;     */
&nbsp;    private double inferirTipoProdutoDeNome(String nomeProduto) {
<b class="nc">&nbsp;        String nome = nomeProduto.toUpperCase();</b>
<b class="nc">&nbsp;        if (nome.contains(&quot;CDB&quot;)) return normalizarTipoProduto(TipoProduto.CDB);</b>
<b class="nc">&nbsp;        if (nome.contains(&quot;LCI&quot;)) return normalizarTipoProduto(TipoProduto.LCI);</b>
<b class="nc">&nbsp;        if (nome.contains(&quot;LCA&quot;)) return normalizarTipoProduto(TipoProduto.LCA);</b>
<b class="nc">&nbsp;        if (nome.contains(&quot;TESOURO&quot;)) return normalizarTipoProduto(TipoProduto.TESOURO_DIRETO);</b>
<b class="nc">&nbsp;        if (nome.contains(&quot;FUNDO&quot;)) return normalizarTipoProduto(TipoProduto.FUNDO);</b>
<b class="nc">&nbsp;        if (nome.contains(&quot;POUPANÇA&quot;) || nome.contains(&quot;POUPANCA&quot;)) return normalizarTipoProduto(TipoProduto.POUPANCA);</b>
<b class="nc">&nbsp;        return 0.5; // Valor neutro se não conseguir inferir</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Infere se tem FGC baseado no nome da simulação
&nbsp;     */
&nbsp;    private double inferirFgcDeNome(String nomeProduto) {
<b class="nc">&nbsp;        String nome = nomeProduto.toUpperCase();</b>
&nbsp;        // Produtos que geralmente têm FGC
<b class="nc">&nbsp;        if (nome.contains(&quot;CDB&quot;) || nome.contains(&quot;LCI&quot;) || nome.contains(&quot;LCA&quot;) || nome.contains(&quot;POUPANÇA&quot;) || nome.contains(&quot;POUPANCA&quot;)) {</b>
<b class="nc">&nbsp;            return 1.0;</b>
&nbsp;        }
&nbsp;        // Produtos que geralmente não têm FGC
<b class="nc">&nbsp;        if (nome.contains(&quot;FUNDO&quot;) || nome.contains(&quot;TESOURO&quot;)) {</b>
<b class="nc">&nbsp;            return 0.0;</b>
&nbsp;        }
<b class="nc">&nbsp;        return 0.5; // Valor neutro se não conseguir inferir</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-16 12:04</div>
</div>
</body>
</html>
